<!DOCTYPE html>
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style data-merge-styles="true"></style>
  <style data-merge-styles="true"></style><style data-merge-styles="true"></style>
  <title>松橋駅　バス乗換案内</title>
  <style>
    table { border-collapse: collapse; width: 95%; margin: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    thead { background: #f0f0f0; font-size: 30px; }
    tbody { font-size: 30px; font-weight: bold;}
    #header {display: flex; text-align: center; background-color: black; color: white; width: 95%; margin: auto; }
    .header-left {display: flex; margin-right: auto; font-size:20px; padding-left: 20px;}
    .header-right {font-size: 18px; display: flex; padding-right:25px; padding-top:6px; }
    p { font-size: 20px; margin: 2px; }
    #time { font-size: 48px; }
    h2 { width: 95%; margin: auto; }

  </style>
  <script defer="">
    const CSV_PATH      = 'merged_kokaibashi.csv';
    const REFRESH_MS    = 15000;  // 更新
    const DISPLAY_COUNT = 5;

    window.addEventListener('DOMContentLoaded', () => {
      updateSchedule();
      setInterval(updateSchedule, REFRESH_MS);
      setInterval(displayCurrentTime, 1000);   // 1秒ごとに時刻更新
    });
    
    // メインのソースコード
    const decoder = require('./gtfsrtpbf.js');
    var fs = require("fs");
    
    async function main() {
      const response = await fetch('https://api-public.odpt.org/api/v4/gtfs/realtime/toei_odpt_train_vehicle');
      const arrayBuffer = await response.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      console.log(uint8Array);
      const feed = decoder.transit_realtime.FeedMessage.decode(uint8Array);
      const str = JSON.stringify(feed, null, 2);
      fs.writeFileSync("gtfsrt.json", str);
    }

    main();
    
    // 現在時刻をフォーマットして表示
    function displayCurrentTime() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const nowtoday = ["日","月","火","水","木","金","土"]
      const formatted = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      document.getElementById('current-time').textContent = (now.getMonth()+1) + '/' + now.getDate() + ' (' + nowtoday[now.getDay()] + ') ' + '現在時刻 : ' + formatted;
    }

    async function updateSchedule() {
      // 1. CSV取得
      const res  = await fetch(CSV_PATH, { cache: 'no-store' });
      const text = await res.text();
      // console.log(text);

      // 2. 行分割＋オブジェクト化
      const lines   = text.split('\n').map(l => l.trim()).filter(l => l);
      // console.log(lines);
      const headers = lines.shift().split(',').map(h => h.trim());
      // console.log(headers)
      const pre_rows    = lines.map(line => {
        const cols = line.split(',').map(c => c.trim());
        // console.log(cols);
        return headers.reduce((o, k, i) => (o[k] = cols[i], o), {});
      });
      // console.log(pre_rows);
      
      let rows = [];
      const today = new Date();
      if (today.getDay() === 1) {
        const allowed = ['0', '1', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 2) {
        const allowed = ['0', '2', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 3) {
        const allowed = ['0', '3', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 4) {
        const allowed = ['0', '4', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 5) {
        const allowed = ['0', '5'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 6) {
        const allowed = ['6'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 0) {
        const allowed = ['7'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      // console.log(rows);
      console.log(today.getDay());

      // 3. 現在時刻を HH:MM に
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const nowHM = `${pad(now.getHours())}:${pad(now.getMinutes())}`;

      // 4. departure_time を HH:MM に切り出し
      const formatted = rows.map(r => {
        const [h, m] = r.departure_time.split(':');
        r._hm = `${pad(Number(h))}:${pad(Number(m))}`;
        return r;
      });

      // 5. 文字列比較でフィルタ（HH:MM同士は辞書式順序でOK）
      const upcoming = formatted
        .filter(r => r._hm >= nowHM)
        .slice(0, DISPLAY_COUNT);

      // 6. テーブル描画
      const tbody = document.querySelector('#schedule tbody');
      tbody.innerHTML = '';
      console.log(upcoming);
      if (upcoming.length === 0) {
        const tr_fin = document.createElement('tr');
        ['trip_headsign', 'route_long_name', '_hm'].forEach(key2 => {  
          const td_fin = document.createElement('td');
          if (key2 === 'route_long_name') {
            td_fin.textContent = '本日の運行は終了しました。(The bus serivce has ended today.)';
            console.log(key2);
          }
          else td_fin.textContent = '---';
          tr_fin.appendChild(td_fin);
        });
        tbody.appendChild(tr_fin);
      }
      else { 
        upcoming.forEach(r => {
          const tr = document.createElement('tr');
          ['trip_headsign', 'route_long_name', '_hm'].forEach(key => {
            const td = document.createElement('td');
            if (key === '_hm') {
              const td_hm = document.createElement('div');
              td_hm.id = 'time';
              td_hm.textContent = key === '_hm' ? r._hm : r[key] || '—';
              td.appendChild(td_hm);
            }
            else td.textContent = key === '_hm' ? r._hm : r[key] || '—';
            const td_en = document.createElement('p');
            if (key === 'trip_headsign') {
              if (r[key] === '熊本駅前') td_en.textContent = 'Kumamoto Sta.';
              else if (r[key] === '川口二丁') td_en.textContent = 'Kawaguchi-Nicho';
              else if (r[key] === 'アクアドーム') td_en.textContent = 'Aqua-Dome';
              else if (r[key] === '五丁') td_en.textContent = 'Gocho';
              else if (r[key] === '桜町バスターミナル') td_en.textContent = 'Kumamoto-Sakuramachi Bus Terminal';
              else if (r[key] === '西部車庫') td_en.textContent = 'Seibu-shako Bus Garage';
              else if (r[key] === '本山営業所') td_en.textContent = 'Motoyama Bus Service Office';
              else if (r[key] === '上熊本駅前') td_en.textContent = 'Kami-Kumamoto Sta.';
              else if (r[key] === '第一環状線') td_en.textContent = 'Loop 1';
              else td_en.textContent = 'Temporary Bus';
            }
            if (key === 'route_long_name') {
              if (r[key] === 'M6-3：松橋駅→城南→イオン→田迎→桜町バスターミナル') td_en.textContent = ' M6-3： Via Jonan, AEONmall Kumamoto, Tamukae';
              else if (r[key] === '４：松橋駅→宮原～八代駅→八代産交') td_en.textContent = ' 4： Via Miyanohara, Yatsushiro Station';
              else if (r[key] === '５：松橋駅→鏡四つ角～大村→八代市役所') td_en.textContent = ' 5：Via Kagami-Yotsukado, Omura';
              else if (r[key] === '松橋駅→大口～三角病院→三角産交') td_en.textContent = 'Via Einoh, Matsuai, Okuchi, Misumi Hospital';
              else if (r[key] === '松橋駅→堅志田～佐俣の湯→砥用中央') td_en.textContent = 'Via Yamazaki-Bridge, Katashida, Samata Hotspring';
              else if (r[key] === '松橋駅→宇土本町二丁目~西城の浦→宇土駅前') td_en.textContent = 'Via Uto High School, Uto-Honmachi 2-Chome, West Jonoura, Uto Station';
              else if (r[key] === '宇土本町二丁目→山崎橋~堅志田→砥用中央') td_en.textContent = 'Yamazaki-Bridge, Katashida, Samata';
              else if (r[key] === '砥用中央→堅志田~山崎橋→宇土本町二丁目') td_en.textContent = 'Via Uto High School, Uto-Honmachi 2-Chome, West Jonoura, Uto Station';
            } 
            console.log(upcoming, r[key], key);
            // td_en.textContent = 'English';
            td.appendChild(td_en);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);  
        });
      }
    }
  </script>
</head>
<body>
  <div id="header">
    <div class="header-left"><h1>松橋駅　バス乗換案内</h1></div>
    <div class="header-right"><h1><div id="current-time">10/10 (金) 現在時刻 : 11:59:59</div></h1></div>
  </div>
  <br>
  <h2><div id="alert">○Alert! : --- No Alert ---</div></h2>
  <br>
  <table id="schedule">
    <thead>
      <tr>
        <th>行先<p>(Destination)</p></th>
        <th>路線名・経由地<p>(Route Name・ Via)</p></th>
        <th>出発予定時刻<p>(Departure Time)</p></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<deepl-input-controller translate="no"><template shadowrootmode="open"><link rel="stylesheet" href="chrome-extension://cofdbpoegempjloogbagkncekinflcnj/build/content.css"><div dir="ltr" style="visibility: initial !important;"><div class="dl-input-translation-container svelte-95aucy"><div></div></div></div></template></deepl-input-controller>
</body>
</html>
