<!DOCTYPE html>
<!-- saved from url=(0034)http://192.168.0.80/ex1/index.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style data-merge-styles="true"></style>
  <style data-merge-styles="true"></style><style data-merge-styles="true"></style>
  <title>松橋駅　バス乗換案内</title>
  <style>
    table { border-collapse: collapse; width: 95%; margin: auto; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    thead { background: #f0f0f0; font-size: 30px; }
    tbody { font-size: 30px; font-weight: bold;}
    #header {display: flex; text-align: center; background-color: black; color: white; width: 95%; margin: auto; }
    .header-left {display: flex; margin-right: auto; font-size:20px; padding-left: 20px;}
    .header-right {font-size: 18px; display: flex; padding-right:25px; padding-top:6px; }
    p { font-size: 20px; margin: 2px; }
    #time { font-size: 48px; }
    h2 { width: 95%; margin: auto; }

  </style>
  <script defer="">
    const CSV_PATH      = 'merged.csv';
    const REFRESH_MS    = 15000;  // 30秒ごと更新
    const DISPLAY_COUNT = 5;

    window.addEventListener('DOMContentLoaded', () => {
      updateSchedule();
      setInterval(updateSchedule, REFRESH_MS);
      setInterval(displayCurrentTime, 1000);   // 1秒ごとに時刻更新
    });
    
    // メインのソースコード
    const decoder = require('./gtfsrtpbf.js');
    var fs = require("fs");
    
    async function main() {
      const response = await fetch('https://api-public.odpt.org/api/v4/gtfs/realtime/toei_odpt_train_vehicle');
      const arrayBuffer = await response.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      console.log(uint8Array);
      const feed = decoder.transit_realtime.FeedMessage.decode(uint8Array);
      const str = JSON.stringify(feed, null, 2);
      fs.writeFileSync("gtfsrt.json", str);
    }

    main();
    
    // 現在時刻をフォーマットして表示
    function displayCurrentTime() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const nowtoday = ["日","月","火","水","木","金","土"]
      const formatted = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      document.getElementById('current-time').textContent = (now.getMonth()+1) + '/' + now.getDate() + ' (' + nowtoday[now.getDay()] + ') ' + '現在時刻 : ' + formatted;
    }

    async function updateSchedule() {
      // 1. CSV取得
      const res  = await fetch(CSV_PATH, { cache: 'no-store' });
      const text = await res.text();
      // console.log(text);

      // 2. 行分割＋オブジェクト化
      const lines   = text.split('\n').map(l => l.trim()).filter(l => l);
      // console.log(lines);
      const headers = lines.shift().split(',').map(h => h.trim());
      // console.log(headers)
      const pre_rows    = lines.map(line => {
        const cols = line.split(',').map(c => c.trim());
        // console.log(cols);
        return headers.reduce((o, k, i) => (o[k] = cols[i], o), {});
      });
      // console.log(pre_rows);
      
      let rows = [];
      const today = new Date();
      if (today.getDay() === 1) {
        const allowed = ['0', '1', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 2) {
        const allowed = ['0', '2', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 3) {
        const allowed = ['0', '3', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 4) {
        const allowed = ['0', '4', '8'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 5) {
        const allowed = ['0', '5'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 6) {
        const allowed = ['6'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      else if (today.getDay() === 0) {
        const allowed = ['7'];
        rows = pre_rows.filter(row => allowed.includes(row.service_id));
      }
      // console.log(rows);
      console.log(today.getDay());

      // 3. 現在時刻を HH:MM に
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const nowHM = `${pad(now.getHours())}:${pad(now.getMinutes())}`;

      // 4. departure_time を HH:MM に切り出し
      const formatted = rows.map(r => {
        const [h, m] = r.departure_time.split(':');
        r._hm = `${pad(Number(h))}:${pad(Number(m))}`;
        return r;
      });

      // 5. 文字列比較でフィルタ（HH:MM同士は辞書式順序でOK）
      const upcoming = formatted
        .filter(r => r._hm >= nowHM)
        .slice(0, DISPLAY_COUNT);

      // 6. テーブル描画
      const tbody = document.querySelector('#schedule tbody');
      tbody.innerHTML = '';
      console.log(upcoming);
      if (upcoming.length === 0) {
        const tr_fin = document.createElement('tr');
        ['trip_headsign', 'route_long_name', '_hm'].forEach(key2 => {  
          const td_fin = document.createElement('td');
          if (key2 === 'route_long_name') {
            td_fin.textContent = '本日の運行は終了しました。(The bus serivce has ended today.)';
            console.log(key2);
          }
          else td_fin.textContent = '---';
          tr_fin.appendChild(td_fin);
        });
        tbody.appendChild(tr_fin);
      }
      else { 
        upcoming.forEach(r => {
          const tr = document.createElement('tr');
          ['trip_headsign', 'route_long_name', '_hm'].forEach(key => {
            const td = document.createElement('td');
            if (key === '_hm') {
              const td_hm = document.createElement('div');
              td_hm.id = 'time';
              td_hm.textContent = key === '_hm' ? r._hm : r[key] || '—';
              td.appendChild(td_hm);
            }
            else td.textContent = key === '_hm' ? r._hm : r[key] || '—';
            const td_en = document.createElement('p');
            if (key === 'trip_headsign') {
              if (r[key] === '八代産交') td_en.textContent = 'Yatsushiro-Sanko Bus Terminal';
              else if (r[key] === '八代市役所前') td_en.textContent = 'Yatsushiro City Office';
              else if (r[key] === '三角産交') td_en.textContent = 'Misumi-Sanko Bus Terminal';
              else if (r[key] === '砥用中央') td_en.textContent = 'Tomochi-Chuo';
              else if (r[key] === '桜町バスターミナル') td_en.textContent = 'Kumamoto-Sakuramachi Bus Terminal';
              else if (r[key] === '宇土駅前') td_en.textContent = 'Uto Station';
              else if (r[key] === '宇土本町二丁目') td_en.textContent = 'Uto-Honmachi 2-Chome';
              else td_en.textContent = 'Temporary Bus';
            }
            if (key === 'route_long_name') {
              if (r[key] === 'M6-3：松橋駅→城南→イオン→田迎→桜町バスターミナル') td_en.textContent = ' M6-3： Via Jonan, AEONmall Kumamoto, Tamukae';
              else if (r[key] === '４：松橋駅→宮原～八代駅→八代産交') td_en.textContent = ' 4： Via Miyanohara, Yatsushiro Station';
              else if (r[key] === '５：松橋駅→鏡四つ角～大村→八代市役所') td_en.textContent = ' 5：Via Kagami-Yotsukado, Omura';
              else if (r[key] === '松橋駅→大口～三角病院→三角産交') td_en.textContent = 'Via Einoh, Matsuai, Okuchi, Misumi Hospital';
              else if (r[key] === '松橋駅→堅志田～佐俣の湯→砥用中央') td_en.textContent = 'Via Yamazaki-Bridge, Katashida, Samata Hotspring';
              else if (r[key] === '松橋駅→宇土本町二丁目~西城の浦→宇土駅前') td_en.textContent = 'Via Uto High School, Uto-Honmachi 2-Chome, West Jonoura, Uto Station';
              else if (r[key] === '宇土本町二丁目→山崎橋~堅志田→砥用中央') td_en.textContent = 'Yamazaki-Bridge, Katashida, Samata';
              else if (r[key] === '砥用中央→堅志田~山崎橋→宇土本町二丁目') td_en.textContent = 'Via Uto High School, Uto-Honmachi 2-Chome, West Jonoura, Uto Station';
            } 
            console.log(upcoming, r[key], key);
            // td_en.textContent = 'English';
            td.appendChild(td_en);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);  
        });
      }
    }
  </script>
</head>
<body>
  <div id="header">
    <div class="header-left"><h1>松橋駅　バス乗換案内</h1></div>
    <div class="header-right"><h1><div id="current-time">10/10 (金) 現在時刻 : 11:59:43</div></h1></div>
  </div>
  <br>
  <h2><div id="alert">○Alert! : --- No Alert ---</div></h2>
  <br>
  <table id="schedule">
    <thead>
      <tr>
        <th>行先<p>(Destination)</p></th>
        <th>路線名・経由地<p>(Route Name・ Via)</p></th>
        <th>出発予定時刻<p>(Departure Time)</p></th>
      </tr>
    </thead>
    <tbody><tr><td>八代産交<p>Yatsushiro-Sanko Bus Terminal</p></td><td>４：松橋駅→宮原～八代駅→八代産交<p> 4： Via Miyanohara, Yatsushiro Station</p></td><td><div id="time">12:10</div><p></p></td></tr><tr><td>砥用中央<p>Tomochi-Chuo</p></td><td>松橋駅→堅志田～佐俣の湯→砥用中央<p>Via Yamazaki-Bridge, Katashida, Samata Hotspring</p></td><td><div id="time">12:47</div><p></p></td></tr><tr><td>八代産交<p>Yatsushiro-Sanko Bus Terminal</p></td><td>４：松橋駅→宮原～八代駅→八代産交<p> 4： Via Miyanohara, Yatsushiro Station</p></td><td><div id="time">13:00</div><p></p></td></tr><tr><td>三角産交<p>Misumi-Sanko Bus Terminal</p></td><td>松橋駅→大口～三角病院→三角産交<p>Via Einoh, Matsuai, Okuchi, Misumi Hospital</p></td><td><div id="time">13:00</div><p></p></td></tr><tr><td>八代市役所前<p>Yatsushiro City Office</p></td><td>５：松橋駅→鏡四つ角～大村→八代市役所<p> 5：Via Kagami-Yotsukado, Omura</p></td><td><div id="time">13:40</div><p></p></td></tr></tbody>
  </table>


<deepl-input-controller translate="no"><template shadowrootmode="open"><link rel="stylesheet" href="chrome-extension://cofdbpoegempjloogbagkncekinflcnj/build/content.css"><div dir="ltr" style="visibility: initial !important;"><div class="dl-input-translation-container svelte-95aucy"><div></div></div></div></template></deepl-input-controller></body><editor-card style="position:absolute;top:0px;left:0px;z-index:auto;display: block !important"><div dir="ltr" style="all: initial;"><div style="color-scheme: initial; forced-color-adjust: initial; mask: initial; math-depth: initial; position: absolute; position-anchor: initial; text-size-adjust: initial; appearance: initial; color: initial; font: initial; font-palette: initial; font-synthesis: initial; position-area: initial; text-orientation: initial; text-rendering: initial; text-spacing-trim: initial; -webkit-font-smoothing: initial; -webkit-locale: initial; -webkit-text-orientation: initial; -webkit-writing-mode: initial; writing-mode: initial; zoom: initial; accent-color: initial; place-content: initial; place-items: initial; place-self: initial; alignment-baseline: initial; anchor-name: initial; anchor-scope: initial; animation-composition: initial; animation: initial; app-region: initial; aspect-ratio: initial; backdrop-filter: initial; backface-visibility: initial; background: initial; background-blend-mode: initial; baseline-shift: initial; baseline-source: initial; block-size: initial; border-block: initial; border: initial; border-radius: initial; border-collapse: initial; border-end-end-radius: initial; border-end-start-radius: initial; border-inline: initial; border-start-end-radius: initial; border-start-start-radius: initial; inset: initial; box-decoration-break: initial; box-shadow: initial; box-sizing: initial; break-after: initial; break-before: initial; break-inside: initial; buffered-rendering: initial; caption-side: initial; caret-animation: initial; caret-color: initial; clear: initial; clip: initial; clip-path: initial; clip-rule: initial; color-interpolation: initial; color-interpolation-filters: initial; color-rendering: initial; columns: initial; column-fill: initial; gap: initial; column-rule: initial; column-span: initial; contain: initial; contain-intrinsic-block-size: initial; contain-intrinsic-size: initial; contain-intrinsic-inline-size: initial; container: initial; content: initial; content-visibility: initial; corner-shape: initial; corner-block-end-shape: initial; corner-block-start-shape: initial; counter-increment: initial; counter-reset: initial; counter-set: initial; cursor: initial; cx: initial; cy: initial; d: initial; display: initial; dominant-baseline: initial; dynamic-range-limit: initial; empty-cells: initial; field-sizing: initial; fill: initial; fill-opacity: initial; fill-rule: initial; filter: initial; flex: initial; flex-flow: initial; float: initial; flood-color: initial; flood-opacity: initial; grid: initial; grid-area: initial; height: initial; hyphenate-character: initial; hyphenate-limit-chars: initial; hyphens: initial; image-orientation: initial; image-rendering: initial; initial-letter: initial; inline-size: initial; inset-block: initial; inset-inline: initial; interpolate-size: initial; isolation: initial; letter-spacing: initial; lighting-color: initial; line-break: initial; list-style: initial; margin-block: initial; margin: initial; margin-inline: initial; marker: initial; mask-type: initial; math-shift: initial; math-style: initial; max-block-size: initial; max-height: initial; max-inline-size: initial; max-width: initial; min-block-size: initial; min-height: initial; min-inline-size: initial; min-width: initial; mix-blend-mode: initial; object-fit: initial; object-position: initial; object-view-box: initial; offset: initial; opacity: initial; order: initial; orphans: initial; outline: initial; outline-offset: initial; overflow-anchor: initial; overflow-block: initial; overflow-clip-margin: initial; overflow-inline: initial; overflow-wrap: initial; overflow: initial; overlay: initial; overscroll-behavior-block: initial; overscroll-behavior-inline: initial; overscroll-behavior: initial; padding-block: initial; padding: initial; padding-inline: initial; page: initial; page-orientation: initial; paint-order: initial; perspective: initial; perspective-origin: initial; pointer-events: initial; position-try: initial; position-visibility: initial; print-color-adjust: initial; quotes: initial; r: initial; reading-flow: initial; reading-order: initial; resize: initial; rotate: initial; ruby-align: initial; ruby-position: initial; rx: initial; ry: initial; scale: initial; scroll-behavior: initial; scroll-initial-target: initial; scroll-margin-block: initial; scroll-margin: initial; scroll-margin-inline: initial; scroll-marker-group: initial; scroll-padding-block: initial; scroll-padding: initial; scroll-padding-inline: initial; scroll-snap-align: initial; scroll-snap-stop: initial; scroll-snap-type: initial; scroll-target-group: initial; scroll-timeline: initial; scrollbar-color: initial; scrollbar-gutter: initial; scrollbar-width: initial; shape-image-threshold: initial; shape-margin: initial; shape-outside: initial; shape-rendering: initial; size: initial; speak: initial; stop-color: initial; stop-opacity: initial; stroke: initial; stroke-dasharray: initial; stroke-dashoffset: initial; stroke-linecap: initial; stroke-linejoin: initial; stroke-miterlimit: initial; stroke-opacity: initial; stroke-width: initial; tab-size: initial; table-layout: initial; text-align: initial; text-align-last: initial; text-anchor: initial; text-autospace: initial; text-box: initial; text-combine-upright: initial; text-decoration: initial; text-decoration-skip-ink: initial; text-emphasis: initial; text-emphasis-position: initial; text-indent: initial; text-overflow: initial; text-shadow: initial; text-transform: initial; text-underline-offset: initial; text-underline-position: initial; text-wrap: initial; timeline-scope: initial; touch-action: initial; transform: initial; transform-box: initial; transform-origin: initial; transform-style: initial; transition: initial; translate: initial; user-select: initial; vector-effect: initial; vertical-align: initial; view-timeline: initial; view-transition-class: initial; view-transition-group: initial; view-transition-name: initial; visibility: initial; border-spacing: initial; -webkit-box-align: initial; -webkit-box-decoration-break: initial; -webkit-box-direction: initial; -webkit-box-flex: initial; -webkit-box-ordinal-group: initial; -webkit-box-orient: initial; -webkit-box-pack: initial; -webkit-box-reflect: initial; -webkit-line-break: initial; -webkit-line-clamp: initial; -webkit-mask-box-image: initial; -webkit-rtl-ordering: initial; -webkit-ruby-position: initial; -webkit-tap-highlight-color: initial; -webkit-text-combine: initial; -webkit-text-decorations-in-effect: initial; -webkit-text-fill-color: initial; -webkit-text-security: initial; -webkit-text-stroke: initial; -webkit-user-drag: initial; white-space-collapse: initial; widows: initial; width: initial; will-change: initial; word-break: initial; word-spacing: initial; x: initial; y: initial; z-index: 2147483647;"><link rel="stylesheet" href="chrome-extension://hokifickgkhplphjiodbggjmoafhignh/fonts/fabric-icons.css"><div style="all: initial;"><template shadowrootmode="open"></template></div></div><div style="color-scheme: initial; forced-color-adjust: initial; mask: initial; math-depth: initial; position: absolute; position-anchor: initial; text-size-adjust: initial; appearance: initial; color: initial; font: initial; font-palette: initial; font-synthesis: initial; position-area: initial; text-orientation: initial; text-rendering: initial; text-spacing-trim: initial; -webkit-font-smoothing: initial; -webkit-locale: initial; -webkit-text-orientation: initial; -webkit-writing-mode: initial; writing-mode: initial; zoom: initial; accent-color: initial; place-content: initial; place-items: initial; place-self: initial; alignment-baseline: initial; anchor-name: initial; anchor-scope: initial; animation-composition: initial; animation: initial; app-region: initial; aspect-ratio: initial; backdrop-filter: initial; backface-visibility: initial; background: initial; background-blend-mode: initial; baseline-shift: initial; baseline-source: initial; block-size: initial; border-block: initial; border: initial; border-radius: initial; border-collapse: initial; border-end-end-radius: initial; border-end-start-radius: initial; border-inline: initial; border-start-end-radius: initial; border-start-start-radius: initial; inset: initial; box-decoration-break: initial; box-shadow: initial; box-sizing: initial; break-after: initial; break-before: initial; break-inside: initial; buffered-rendering: initial; caption-side: initial; caret-animation: initial; caret-color: initial; clear: initial; clip: initial; clip-path: initial; clip-rule: initial; color-interpolation: initial; color-interpolation-filters: initial; color-rendering: initial; columns: initial; column-fill: initial; gap: initial; column-rule: initial; column-span: initial; contain: initial; contain-intrinsic-block-size: initial; contain-intrinsic-size: initial; contain-intrinsic-inline-size: initial; container: initial; content: initial; content-visibility: initial; corner-shape: initial; corner-block-end-shape: initial; corner-block-start-shape: initial; counter-increment: initial; counter-reset: initial; counter-set: initial; cursor: initial; cx: initial; cy: initial; d: initial; display: initial; dominant-baseline: initial; dynamic-range-limit: initial; empty-cells: initial; field-sizing: initial; fill: initial; fill-opacity: initial; fill-rule: initial; filter: initial; flex: initial; flex-flow: initial; float: initial; flood-color: initial; flood-opacity: initial; grid: initial; grid-area: initial; height: initial; hyphenate-character: initial; hyphenate-limit-chars: initial; hyphens: initial; image-orientation: initial; image-rendering: initial; initial-letter: initial; inline-size: initial; inset-block: initial; inset-inline: initial; interpolate-size: initial; isolation: initial; letter-spacing: initial; lighting-color: initial; line-break: initial; list-style: initial; margin-block: initial; margin: initial; margin-inline: initial; marker: initial; mask-type: initial; math-shift: initial; math-style: initial; max-block-size: initial; max-height: initial; max-inline-size: initial; max-width: initial; min-block-size: initial; min-height: initial; min-inline-size: initial; min-width: initial; mix-blend-mode: initial; object-fit: initial; object-position: initial; object-view-box: initial; offset: initial; opacity: initial; order: initial; orphans: initial; outline: initial; outline-offset: initial; overflow-anchor: initial; overflow-block: initial; overflow-clip-margin: initial; overflow-inline: initial; overflow-wrap: initial; overflow: initial; overlay: initial; overscroll-behavior-block: initial; overscroll-behavior-inline: initial; overscroll-behavior: initial; padding-block: initial; padding: initial; padding-inline: initial; page: initial; page-orientation: initial; paint-order: initial; perspective: initial; perspective-origin: initial; pointer-events: initial; position-try: initial; position-visibility: initial; print-color-adjust: initial; quotes: initial; r: initial; reading-flow: initial; reading-order: initial; resize: initial; rotate: initial; ruby-align: initial; ruby-position: initial; rx: initial; ry: initial; scale: initial; scroll-behavior: initial; scroll-initial-target: initial; scroll-margin-block: initial; scroll-margin: initial; scroll-margin-inline: initial; scroll-marker-group: initial; scroll-padding-block: initial; scroll-padding: initial; scroll-padding-inline: initial; scroll-snap-align: initial; scroll-snap-stop: initial; scroll-snap-type: initial; scroll-target-group: initial; scroll-timeline: initial; scrollbar-color: initial; scrollbar-gutter: initial; scrollbar-width: initial; shape-image-threshold: initial; shape-margin: initial; shape-outside: initial; shape-rendering: initial; size: initial; speak: initial; stop-color: initial; stop-opacity: initial; stroke: initial; stroke-dasharray: initial; stroke-dashoffset: initial; stroke-linecap: initial; stroke-linejoin: initial; stroke-miterlimit: initial; stroke-opacity: initial; stroke-width: initial; tab-size: initial; table-layout: initial; text-align: initial; text-align-last: initial; text-anchor: initial; text-autospace: initial; text-box: initial; text-combine-upright: initial; text-decoration: initial; text-decoration-skip-ink: initial; text-emphasis: initial; text-emphasis-position: initial; text-indent: initial; text-overflow: initial; text-shadow: initial; text-transform: initial; text-underline-offset: initial; text-underline-position: initial; text-wrap: initial; timeline-scope: initial; touch-action: initial; transform: initial; transform-box: initial; transform-origin: initial; transform-style: initial; transition: initial; translate: initial; user-select: initial; vector-effect: initial; vertical-align: initial; view-timeline: initial; view-transition-class: initial; view-transition-group: initial; view-transition-name: initial; visibility: initial; border-spacing: initial; -webkit-box-align: initial; -webkit-box-decoration-break: initial; -webkit-box-direction: initial; -webkit-box-flex: initial; -webkit-box-ordinal-group: initial; -webkit-box-orient: initial; -webkit-box-pack: initial; -webkit-box-reflect: initial; -webkit-line-break: initial; -webkit-line-clamp: initial; -webkit-mask-box-image: initial; -webkit-rtl-ordering: initial; -webkit-ruby-position: initial; -webkit-tap-highlight-color: initial; -webkit-text-combine: initial; -webkit-text-decorations-in-effect: initial; -webkit-text-fill-color: initial; -webkit-text-security: initial; -webkit-text-stroke: initial; -webkit-user-drag: initial; white-space-collapse: initial; widows: initial; width: initial; will-change: initial; word-break: initial; word-spacing: initial; x: initial; y: initial; z-index: 2147483647;"><link rel="stylesheet" href="chrome-extension://hokifickgkhplphjiodbggjmoafhignh/fonts/fabric-icons.css"></div></div></editor-card></html>